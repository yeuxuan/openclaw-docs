# 20 核心模块记忆索引

## 你要“记住”的核心模块（按优先级）

1. 智能体执行主链
- `src/auto-reply/reply/agent-runner-execution.ts`
- `src/agents/pi-embedded-runner/run.ts`
- `src/agents/pi-embedded-runner/run/attempt.ts`

2. 工具与安全策略
- `src/agents/pi-tools.ts`
- `src/agents/pi-tools.policy.ts`
- `src/agents/tool-policy-pipeline.ts`

3. 并发与会话隔离
- `src/process/command-queue.ts`
- `src/agents/pi-embedded-runner/lanes.ts`
- `src/agents/pi-embedded-runner/runs.ts`

4. 流式回复与事件
- `src/agents/pi-embedded-subscribe.ts`
- `src/agents/pi-embedded-runner/run/payloads.ts`

5. 子智能体编排
- `src/agents/tools/sessions-spawn-tool.ts`
- `src/agents/subagent-registry.ts`

6. 技能系统
- `src/agents/skills/workspace.ts`
- `src/agents/skills/env-overrides.ts`
- `src/agents/skills/refresh.ts`

7. 失败恢复
- `src/agents/model-fallback.ts`
- `src/agents/pi-embedded-helpers.ts`

8. 函数级必记（智能体框架）
- `runEmbeddedPiAgent` (`src/agents/pi-embedded-runner/run.ts`)
- `runEmbeddedAttempt` (`src/agents/pi-embedded-runner/run/attempt.ts`)
- `subscribeEmbeddedPiSession` (`src/agents/pi-embedded-subscribe.ts`)
- `createOpenClawCodingTools` (`src/agents/pi-tools.ts`)
- `runAgentTurnWithFallback` (`src/auto-reply/reply/agent-runner-execution.ts`)

9. Gateway 控制平面必记
- `startGatewayServer` (`src/gateway/server.impl.ts`)
- `attachGatewayWsConnectionHandler` (`src/gateway/server/ws-connection.ts`)
- `attachGatewayWsMessageHandler` (`src/gateway/server/ws-connection/message-handler.ts`)
- `authorizeGatewayMethod` (`src/gateway/server-methods.ts`)
- `handleGatewayRequest` (`src/gateway/server-methods.ts`)
- `createGatewayBroadcaster` (`src/gateway/server-broadcast.ts`)
- `NodeRegistry.invoke/handleInvokeResult` (`src/gateway/node-registry.ts`)

10. Gateway HTTP 与生命周期必记
- `createGatewayHttpServer` (`src/gateway/server-http.ts`)
- `attachGatewayUpgradeHandler` (`src/gateway/server-http.ts`)
- `handleOpenAiHttpRequest` (`src/gateway/openai-http.ts`)
- `handleOpenResponsesHttpRequest` (`src/gateway/openresponses-http.ts`)
- `startGatewayConfigReloader` (`src/gateway/config-reload.ts`)
- `createGatewayReloadHandlers` (`src/gateway/server-reload-handlers.ts`)
- `createGatewayCloseHandler` (`src/gateway/server-close.ts`)
- `createHooksRequestHandler` (`src/gateway/server-http.ts`)
- `handleToolsInvokeHttpRequest` (`src/gateway/tools-invoke-http.ts`)

11. 协议层必记
- `validateRequestFrame/validateConnectParams` (`src/gateway/protocol/index.ts`)
- `GatewayFrameSchema` (`src/gateway/protocol/schema/frames.ts`)
- `ProtocolSchemas` (`src/gateway/protocol/schema/protocol-schemas.ts`)
- `PROTOCOL_VERSION` (`src/gateway/protocol/schema/protocol-schemas.ts`)

12. 已补齐核心（系统胶水层）
- `resolveGatewayRuntimeConfig` (`src/gateway/server-runtime-config.ts`)
- `startGatewayTailscaleExposure` (`src/gateway/server-tailscale.ts`)
- `startGatewayDiscovery` (`src/gateway/server-discovery-runtime.ts`)
- `applyGatewayLaneConcurrency` (`src/gateway/server-lanes.ts`)
- `loadGatewayModelCatalog` (`src/gateway/server-model-catalog.ts`)
- `resolveSessionKeyForRun` (`src/gateway/server-session-key.ts`)
- `startGatewayMemoryBackend` (`src/gateway/server-startup-memory.ts`)
- `ExecApprovalManager` (`src/gateway/exec-approval-manager.ts`)

对应拆解文档：
- `45-函数级剖析-server-runtime-config.md`
- `46-函数级剖析-server-tailscale.md`
- `47-函数级剖析-server-discovery-runtime.md`
- `48-函数级剖析-server-lanes.md`
- `49-函数级剖析-server-model-catalog.md`
- `50-函数级剖析-server-session-key.md`
- `51-函数级剖析-server-startup-memory.md`
- `52-函数级剖析-exec-approval-manager.md`

## 快速自测（你是否真正掌握）

1. 你能说清楚为什么要“session lane + global lane”吗？
2. 你能说清楚工具策略为何是“先聚合后过滤”吗？
3. 你能说清楚 compaction 与 model fallback 的先后关系吗？
4. 你能说清楚子智能体为什么不能继续 spawn 吗？
5. 你能说清楚为什么 `connect.challenge + device nonce` 能降低重放风险吗？
6. 你能说清楚 `operator.read/write/admin` 和 `pairing/approvals` scope 的分工吗？
7. 你能说清楚 `openai-http` 与 `openresponses-http` 在输入/流式协议上的差异吗？
8. 你能说清楚什么配置变化可以热重载，什么变化必须重启吗？
9. 你能说清楚为什么 gateway 在业务 handler 前要做 schema 校验吗？

如果这 9 题都能用自己的话说清楚，你已经具备复刻该框架的能力。
