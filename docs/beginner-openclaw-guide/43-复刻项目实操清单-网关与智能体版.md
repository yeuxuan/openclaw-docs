# 43 复刻项目实操清单 网关与智能体版

这篇是给你“真正动手做”的。  
不是讲概念，而是把前面 1-42 的拆解变成可执行清单。

## 步骤一：先搭最小可运行版本

1. 做一个最小 `gateway` 进程：
- WS server
- `connect` 握手
- `req/res/event` 三种帧

2. 只保留 3 个 method：
- `health`
- `chat.send`
- `chat.history`

3. 先把消息回显跑通（不用模型），确认协议和会话存储正确。

## 步骤二：按模块逐步扩展

### A. 第一阶段（控制面骨架）

1. 鉴权与 scope（`operator.read/write/admin`）
2. broadcast + 慢消费者处理
3. dedupe 与 runId 幂等

通过标准：
- 同一个 idempotencyKey 不会重复执行
- 非法 role/scope 请求被拒绝

### B. 第二阶段（智能体执行）

1. 接入 agent runner（先单模型单 provider）
2. 接入工具系统（先 1-2 个工具）
3. 接入 session lane，保证会话隔离

通过标准：
- 同一 session 顺序稳定
- 不同 session 可并发

### C. 第三阶段（HTTP 面）

1. `/v1/chat/completions`
2. `/v1/responses`
3. `/tools/invoke`

通过标准：
- 流式与非流式都可工作
- 输入超限/鉴权失败返回一致错误结构

### D. 第四阶段（工程稳定性）

1. config 热重载规则
2. 重启哨兵
3. 优雅关停

通过标准：
- 配置变更不误伤在途任务
- 重启后能把结果回送到原会话


